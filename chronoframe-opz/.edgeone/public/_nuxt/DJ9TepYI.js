import{C as ne,c5 as ue,r,c6 as re,c1 as ce,as as he,j as $,v as ve,A as R,z as de,c,o as n,a as f,M as E,R as h,aG as fe,P as me,O as s,b as w,a1 as pe,a0 as W,a2 as ge,c7 as ye,aH as be,w as H,t as p,d as X,F as xe,a5 as ke,aw as we,a6 as Pe,c8 as Le,Y as Te}from"./j4_2ViiT.js";const Me={class:"relative group overflow-hidden transition-all duration-300"},Re={class:"text-white flex flex-col gap-1"},Ie={class:"flex flex-col"},Ve={key:0,class:"text-base font-medium text-ellipsis line-clamp-1"},Ue={key:1,class:"text-xs text-justify opacity-80 line-clamp-2"},Fe={key:2,class:"text-xs font-medium opacity-80"},Oe={key:0},Ne={key:1},Ee={key:0},Se={key:0,class:"mt-1 flex items-center gap-1"},Ce={key:0,class:"text-sm opacity-70 mt-1 flex items-center gap-1"},je={class:"text-xs font-medium text-ellipsis line-clamp-1"},Ye={key:1,class:"text-sm opacity-70 mt-1 flex gap-2"},ze={key:0,class:"flex items-center gap-0.5"},Be={class:"text-xs font-medium"},De={key:1,class:"flex items-center gap-0.5"},_e={class:"text-xs font-medium"},$e={key:2,class:"flex items-center gap-0.5"},We={class:"text-xs font-medium"},He={key:3,class:"flex items-center gap-0.5"},Xe={class:"text-xs font-medium"},Ae=ne({__name:"Photo",props:{photo:{},index:{}},emits:["visibility-change","openViewer"],setup(t,{emit:A}){const i=t,S=A,{gtag:G}=ue(),P=r(!0),g=r(),o=re(),I=r(!1),C=r(0),x=r(!1),l=r(!1),V=r(!1),j=r(null),m=r(null),{convertMovToMp4:Q,getProcessingState:Z}=ce(),y=r(!1),M=r(0),k=r(null),L=r(null),v=he("(max-width: 768px)"),U=r(null),F=r(null),Y=Z(i.photo.id),q=$(()=>i.photo.aspectRatio?i.photo.aspectRatio:i.photo.width&&i.photo.height?i.photo.height/i.photo.width:1.2),O=$(()=>i.photo.isLivePhoto?v.value?!(y.value||l.value):x.value?l.value?!1:V.value:!0:!0),J=()=>{P.value=!1},K=()=>{P.value=!1,console.warn(`Failed to load image: ${i.photo.thumbnailUrl}`)},ee=async()=>{v.value||(x.value=!0,!(!i.photo.isLivePhoto||!i.photo.livePhotoVideoUrl)&&(j.value&&m.value&&V.value?z():Y.value?.isProcessing||D()))},te=()=>{v.value||(x.value=!1,o.value&&!o.value.paused&&(o.value.pause(),o.value.currentTime=0),setTimeout(()=>{!x.value&&!y.value&&(l.value=!1)},150))},z=()=>{!o.value||!m.value||(o.value.readyState<2&&o.value.load(),o.value.currentTime=0,l.value=!0,v.value&&"vibrate"in navigator&&navigator.vibrate(50),R(()=>{if(!o.value||!l.value)return;o.value.muted=!0,o.value.playsInline=!0;const e=o.value.play();e!==void 0&&e.then(()=>{o.value&&o.value.paused}).catch(a=>{console.warn("Failed to play LivePhoto video:",a),l.value=!1,a.name==="NotAllowedError"&&(console.log("Video play blocked by browser policy, retrying..."),o.value&&(o.value.load(),setTimeout(()=>{if(o.value&&l.value){const u=o.value.play();u!==void 0&&u.catch(()=>{l.value=!1})}},100)))})}))},oe=()=>{v.value&&"vibrate"in navigator&&navigator.vibrate(30),setTimeout(()=>{l.value=!1},100)},ae=e=>{if(!(!v.value||!i.photo.isLivePhoto||!m.value)&&(M.value=e.touches.length,e.touches.length===1)){const a=e.touches[0];a&&(L.value={x:a.clientX,y:a.clientY},y.value=!0,k.value=setTimeout(()=>{y.value&&M.value===1&&z()},350))}},se=e=>{if(!v.value||!y.value||!L.value)return;if(M.value=e.touches.length,e.touches.length>1){N();return}const a=e.touches[0];if(a){const u=Math.abs(a.clientX-L.value.x),d=Math.abs(a.clientY-L.value.y),b=10;(u>b||d>b)&&N()}},B=()=>{v.value&&N()},N=()=>{const e=l.value;M.value=0,y.value=!1,L.value=null,k.value&&(clearTimeout(k.value),k.value=null),o.value&&!o.value.paused&&(o.value.pause(),o.value.currentTime=0,v.value&&e&&"vibrate"in navigator&&navigator.vibrate(25)),setTimeout(()=>{!y.value&&!x.value&&(l.value=!1)},150)},ie=e=>{if(v.value&&(l.value||y.value)){e.preventDefault(),e.stopPropagation();return}G("event","photo_view",{photo_id:i.photo.id,photo_title:i.photo.title||"Untitled",has_live_photo:i.photo.isLivePhoto?"yes":"no"}),S("openViewer",i.index)},D=async()=>{if(!(!i.photo.isLivePhoto||!i.photo.livePhotoVideoUrl||!I.value))try{const e=await Q(i.photo.livePhotoVideoUrl,i.photo.id);e&&(j.value=e,m.value&&URL.revokeObjectURL(m.value),m.value=URL.createObjectURL(e),V.value=!0,o.value&&o.value.load())}catch(e){console.error("Failed to process LivePhoto:",e)}},le=e=>{if(!e)return"";let a;if(typeof e=="string"){if(e.includes("/")){const u=e.split("/");if(u.length===2&&u[0]&&u[1]){const d=parseFloat(u[0]),b=parseFloat(u[1]);if(!isNaN(d)&&!isNaN(b)&&b!==0)a=d/b;else return e}else return e}else if(a=parseFloat(e),isNaN(a))return e}else a=e;return a>=1?`${a}s`:`1/${Math.round(1/a)}`};return ve(()=>{if(R(()=>{if(g.value){C.value=g.value.offsetWidth;const e=new ResizeObserver(()=>{g.value&&(C.value=g.value.offsetWidth)});e.observe(g.value),U.value=e}}),i.photo.thumbnailUrl){const e=new Image;e.onload=()=>{P.value=!1},e.onerror=()=>{P.value=!1},e.src=i.photo.thumbnailUrl}else P.value=!1;R(()=>{if(g.value){const e=new IntersectionObserver(a=>{a.forEach(u=>{const d=u.isIntersecting;d!==I.value&&(I.value=d,S("visibility-change",{index:i.index,isVisible:d,date:i.photo.dateTaken||new Date().toISOString()}),d&&R(()=>{D()}))})},{threshold:.1,rootMargin:"50px 0px 50px 0px"});e.observe(g.value),F.value=e}})}),de(()=>{U.value&&U.value.disconnect(),F.value&&F.value.disconnect(),k.value&&(clearTimeout(k.value),k.value=null),m.value&&URL.revokeObjectURL(m.value)}),(e,a)=>{const u=pe,d=ye,b=we,T=Pe;return n(),c("div",{ref_key:"photoRef",ref:g,class:"w-full transition-all duration-300 cursor-pointer select-none",style:{transform:"translateZ(0)"},onClick:ie,onMouseenter:ee,onMouseleave:te,onTouchstart:ae,onTouchmove:se,onTouchend:B,onTouchcancel:B,onContextmenu:a[1]||(a[1]=Te(()=>{},["prevent"]))},[f("div",Me,[f("div",{class:"w-full relative",style:me({aspectRatio:s(q)})},[w(u,{src:t.photo.thumbnailUrl||"",alt:t.photo.title||"Photo thumbnail",thumbhash:t.photo.thumbnailHash||"",class:"absolute inset-0 w-full h-full object-cover transition-transform duration-500 group-hover:scale-105",onLoad:J,onError:K},null,8,["src","alt","thumbhash"]),t.photo.isLivePhoto&&s(m)?(n(),E(s(W).video,{key:0,ref_key:"videoRef",ref:o,src:s(m),class:ge(["absolute inset-0 w-full h-full object-cover",{"select-none pointer-events-none":s(l)}]),muted:"",playsinline:"",preload:"metadata",initial:{opacity:0,scale:1.02},animate:{opacity:s(l)?1:0,scale:s(l)?1:1.02},transition:{duration:s(l)?.3:.2,ease:s(l)?[.23,1,.32,1]:[.25,.46,.45,.94],delay:s(l)?.05:0},onEnded:oe,onLoadeddata:a[0]||(a[0]=()=>{s(o)&&!s(l)&&(s(o).currentTime=.1,s(o).pause())})},null,8,["src","class","animate","transition"])):h("",!0)],4),a[2]||(a[2]=f("div",{class:"absolute inset-0 bg-black/0 group-hover:bg-black/20 transition-colors duration-300"},null,-1)),t.photo.isLivePhoto?(n(),E(d,{key:0,class:"absolute top-2 left-2",photo:t.photo,"is-video-playing":s(l),"processing-state":s(Y)||null},null,8,["photo","is-video-playing","processing-state"])):h("",!0),fe(w(s(W).div,{class:"absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/60 to-transparent p-3",initial:{y:"100%",opacity:0},animate:{y:s(O)&&s(x)&&!s(v)?0:"100%",opacity:s(O)&&s(x)&&!s(v)?1:0},transition:{duration:.3,ease:[.25,.1,.25,1]}},{default:H(()=>[f("div",Re,[f("div",Ie,[t.photo.title?(n(),c("p",Ve,p(t.photo.title),1)):h("",!0),t.photo.description?(n(),c("p",Ue,p(t.photo.description),1)):h("",!0),t.photo.dateTaken||t.photo.city?(n(),c("p",Fe,[t.photo.dateTaken?(n(),c("span",Oe,p(e.$dayjs(t.photo.dateTaken).format("YYYY-MM-DD")),1)):h("",!0),t.photo.city?(n(),c("span",Ne,[t.photo.dateTaken?(n(),c("span",Ee," Â· ")):h("",!0),X(p(t.photo.city),1)])):h("",!0)])):h("",!0)]),t.photo.tags?.length?(n(),c("div",Se,[(n(!0),c(xe,null,ke(t.photo.tags,_=>(n(),E(b,{key:_,size:"sm",color:"neutral",class:"bg-white/20 text-white/80 backdrop-blur-3xl"},{default:H(()=>[X(p(_),1)]),_:2},1024))),128))])):h("",!0),f("div",null,[t.photo.exif&&(t.photo.exif.Make||t.photo.exif.Model)?(n(),c("div",Ce,[w(T,{name:"tabler:camera"}),f("span",je,p(s(Le)(t.photo.exif.Make,t.photo.exif.Model)),1)])):h("",!0),t.photo.exif&&(t.photo.exif.FNumber||t.photo.exif.ExposureTime||t.photo.exif.ISO)?(n(),c("div",Ye,[t.photo.exif.FocalLengthIn35mmFormat?(n(),c("div",ze,[w(T,{name:"streamline:image-accessories-lenses-photos-camera-shutter-picture-photography-pictures-photo-lens",class:"-mt-0.5"}),f("span",Be,p(t.photo.exif.FocalLengthIn35mmFormat),1)])):h("",!0),t.photo.exif.FNumber?(n(),c("div",De,[w(T,{name:"tabler:aperture",class:"-mt-0.5"}),f("span",_e," f/"+p(t.photo.exif.FNumber),1)])):h("",!0),t.photo.exif.ExposureTime?(n(),c("div",$e,[w(T,{name:"material-symbols:shutter-speed",class:"-mt-0.5"}),f("span",We,p(le(t.photo.exif.ExposureTime)),1)])):h("",!0),t.photo.exif.ISO?(n(),c("div",He,[w(T,{name:"carbon:iso-outline",class:"-mt-0.5"}),f("span",Xe,p(t.photo.exif.ISO),1)])):h("",!0)])):h("",!0)])])]),_:1},8,["animate"]),[[be,s(O)]])])],544)}}}),Qe=Object.assign(Ae,{__name:"MasonryItemPhoto"});export{Qe as _};
