import{C as Q,a9 as W,u as G,aj as X,r as b,aA as Y,j as U,E as Z,ah as D,aB as ee,az as ae,M as C,w as r,aC as te,o as u,a as o,b as d,O as t,av as S,c as f,R as _,t as i,d as y,ay as se,_ as oe}from"./Do4Ulm4h.js";import{_ as le,a as re}from"./BxJwlH6u.js";import{_ as ie}from"./CdCamvbH.js";import{_ as de}from"./D2mnJjkG.js";import{_ as ne}from"./DOw8EvtE.js";import{_ as ce}from"./Dt03dVmC.js";import"./D4m22CMA.js";import"./Bzg-qYo_.js";import"./Du2f8F9w.js";import"./zoi52lI1.js";import"./y8VeKFcA.js";import"./D8I6Rcxg.js";import"./C8barOil.js";import"./MPJDxmQh.js";import"./Qxlw5ViT.js";import"./DBhqu3Ka.js";import"./DN8WM3HB.js";import"./D_BgBUvd.js";const ue={class:"flex flex-col gap-6"},pe={class:"grid grid-cols-2 lg:grid-cols-4 gap-4"},he={class:"flex items-center justify-between pb-2"},me={class:"flex items-center gap-2"},ge={class:"space-y-4"},be={class:"text-sm"},fe={key:0,class:"text-xs text-gray-500"},_e={key:1,class:"text-xs text-gray-400"},ye={class:"text-sm"},ve={class:"flex items-center gap-1"},xe={key:2,class:"text-xs text-gray-400"},qe={class:"px-2"},ke={class:"space-y-3"},$e={class:"flex gap-4"},Ce={class:"text-sm capitalize"},Se={class:"text-xs text-neutral-500"},Te={class:"font-mono text-sm"},Ae={class:"text-xs text-neutral-500"},Ee={class:"text-sm capitalize"},Ue={key:0,class:"mt-3"},De={class:"text-xs text-neutral-500 mb-1"},Fe={class:"p-3 bg-red-50 dark:bg-red-950/20 rounded border border-red-100 dark:border-red-900/30"},Ie={class:"text-sm text-red-700 dark:text-red-300 wrap-break-word font-mono"},Ve={key:1,class:"mt-3"},ze={class:"text-xs bg-neutral-100/50 dark:bg-neutral-800/50 p-2 rounded overflow-x-auto text-neutral-700 dark:text-neutral-300"},Be=Q({__name:"queue",async setup(we){let v,T;const{t:e}=W(),h=D;G({title:e("dashboard.queue.title")});const c=X(),n=b(!1),F=b([]),m=b("all"),g=b("all"),{data:k,refresh:I}=([v,T]=Y(()=>te("/api/queue/task/list",{query:U(()=>({...m.value!=="all"&&{status:m.value},...g.value!=="all"&&{type:g.value}}))},"$Uoc06oW9fj")),v=await v,T(),v),x=U(()=>{if(!k.value?.data)return{pending:0,processing:0,completed:0,failed:0};const s={pending:0,processing:0,completed:0,failed:0};return k.value.data.forEach(l=>{l.status==="pending"?s.pending++:l.status==="in-stages"?s.processing++:l.status==="completed"?s.completed++:l.status==="failed"&&s.failed++}),s}),p=async()=>{n.value=!0;try{await I(),F.value=[]}finally{n.value=!1}},V=async()=>{try{n.value=!0;const s=await $fetch("/api/queue/task/clear",{method:"DELETE",query:{includeCompleted:"true",includeFailed:"true"}});c.add({title:e("dashboard.queue.messages.clearSuccess"),description:`清除了 ${s.deletedCount} 个任务`,color:"success"}),await p()}catch(s){console.error("Clear tasks failed:",s),c.add({title:e("dashboard.queue.messages.operationFailed"),description:s?.message||"清理任务失败",color:"error"})}finally{n.value=!1}},z=async s=>{try{await $fetch("/api/queue/task/retry",{method:"POST",body:{taskId:s}}),c.add({title:e("dashboard.queue.messages.retrySuccess"),color:"success"}),await p()}catch(l){console.error("Retry task failed:",l),c.add({title:e("dashboard.queue.messages.operationFailed"),description:l?.message||"重试任务失败",color:"error"})}},B=async()=>{try{n.value=!0;const s=await $fetch("/api/queue/task/retry-batch",{method:"POST",body:{retryAll:!0}});c.add({title:e("dashboard.queue.messages.batchRetrySuccess"),description:`重试了 ${s.retriedCount} 个任务`,color:"success"}),await p()}catch(s){console.error("Batch retry failed:",s),c.add({title:e("dashboard.queue.messages.operationFailed"),description:s?.message||"批量重试失败",color:"error"})}finally{n.value=!1}},w=async s=>{try{await $fetch(`/api/queue/failed/${s}`,{method:"DELETE"}),c.add({title:e("dashboard.queue.messages.deleteSuccess"),color:"success"}),await p()}catch(l){console.error("Delete task failed:",l),c.add({title:e("dashboard.queue.messages.operationFailed"),description:l?.message||"删除任务失败",color:"error"})}},N=s=>{switch(s){case"pending":return"warning";case"in-stages":return"info";case"completed":return"success";case"failed":return"error";default:return"neutral"}},M=[{label:e("dashboard.queue.filters.all"),value:"all"},{label:e("dashboard.queue.status.pending"),value:"pending"},{label:e("dashboard.queue.status.in-stages"),value:"in-stages"},{label:e("dashboard.queue.status.completed"),value:"completed"},{label:e("dashboard.queue.status.failed"),value:"failed"}],K=[{label:e("dashboard.queue.filters.all"),value:"all"},{label:e("dashboard.queue.types.photo"),value:"photo"},{label:e("dashboard.queue.types.live-photo-video"),value:"live-photo-video"},{label:e("dashboard.queue.types.photo-reverse-geocoding"),value:"photo-reverse-geocoding"}],$=b({}),O=[{id:"expand",cell:({row:s})=>Z(D,{color:"neutral",variant:"ghost",icon:"tabler:chevron-down",square:!0,"aria-label":"Expand",ui:{leadingIcon:["transition-transform",s.getIsExpanded()?"duration-200 rotate-180":""]},onClick:()=>s.toggleExpanded()}),enableSorting:!1,enableHiding:!1},{accessorKey:"id",header:e("dashboard.queue.table.id")},{id:"type",accessorFn:s=>s.payload.type,header:e("dashboard.queue.table.type")},{accessorKey:"status",header:e("dashboard.queue.table.status")},{accessorKey:"attempts",header:e("dashboard.queue.table.attempts")},{accessorKey:"priority",header:e("dashboard.queue.table.priority")},{accessorKey:"statusStage",header:e("dashboard.queue.table.stage")},{accessorKey:"createdAt",header:e("dashboard.queue.table.createdAt")},{id:"actions",header:e("dashboard.queue.table.actions")}],j=ee(p,1e4);return ae(()=>{clearInterval(j)}),(s,l)=>{const P=re,q=ie,A=de,E=se,H=ne,R=ce,L=le;return u(),C(L,null,{header:r(()=>[d(P,{title:t(e)("dashboard.queue.title")},{right:r(()=>[d(t(h),{icon:"tabler:refresh",variant:"soft",loading:t(n),onClick:p},{default:r(()=>[y(i(t(e)("dashboard.queue.actions.refresh")),1)]),_:1},8,["loading"]),d(t(h),{icon:"tabler:refresh",color:"warning",variant:"soft",loading:t(n),onClick:B},{default:r(()=>[y(i(t(e)("dashboard.queue.actions.retryAll")),1)]),_:1},8,["loading"]),d(t(h),{icon:"tabler:trash",color:"error",variant:"soft",loading:t(n),onClick:V},{default:r(()=>[y(i(t(e)("dashboard.queue.actions.clearNonActive")),1)]),_:1},8,["loading"])]),_:1},8,["title"])]),body:r(()=>[o("div",ue,[o("div",pe,[d(q,{title:t(e)("dashboard.queue.indicator.pending"),icon:"tabler:clock",color:"orange",value:t(x).pending},null,8,["title","value"]),d(q,{title:t(e)("dashboard.queue.indicator.processing"),icon:"tabler:loader",color:"blue",value:t(x).processing},null,8,["title","value"]),d(q,{title:t(e)("dashboard.queue.indicator.completed"),icon:"tabler:check",color:"green",value:t(x).completed},null,8,["title","value"]),d(q,{title:t(e)("dashboard.queue.indicator.failed"),icon:"tabler:alert-triangle",color:"red",value:t(x).failed},null,8,["title","value"])]),d(R,null,{header:r(()=>[o("div",he,[l[3]||(l[3]=o("h2",{class:"text-lg font-semibold"},"队列任务列表",-1)),o("div",me,[d(A,{modelValue:t(m),"onUpdate:modelValue":l[0]||(l[0]=a=>S(m)?m.value=a:null),items:M,"value-key":"value",size:"sm",variant:"soft",class:"w-32","search-input":!1},null,8,["modelValue"]),d(A,{modelValue:t(g),"onUpdate:modelValue":l[1]||(l[1]=a=>S(g)?g.value=a:null),items:K,"value-key":"value",size:"sm",variant:"soft",class:"w-32","search-input":!1},null,8,["modelValue"])])])]),default:r(()=>[o("div",ge,[d(H,{expanded:t($),"onUpdate:expanded":l[2]||(l[2]=a=>S($)?$.value=a:null),data:t(k)?.data||[],columns:O,loading:t(n),"empty-state":{icon:"tabler:inbox",label:t(e)("dashboard.queue.messages.noTasks")},class:"w-full"},{"type-cell":r(({row:a})=>[d(E,{label:t(e)(`dashboard.queue.types.${a.original.payload.type}`),variant:"soft",color:a.original.payload.type==="photo"?"info":"secondary",size:"sm"},null,8,["label","color"])]),"status-cell":r(({row:a})=>[d(E,{label:t(e)(`dashboard.queue.status.${a.original.status}`),variant:"soft",color:N(a.original.status),size:"sm"},null,8,["label","color"])]),"attempts-cell":r(({row:a})=>[o("span",be,i(a.original.attempts)+"/"+i(a.original.maxAttempts),1)]),"statusStage-cell":r(({row:a})=>[a.original.statusStage?(u(),f("span",fe,i(t(e)(`dashboard.queue.stages.${a.original.statusStage}`)),1)):(u(),f("span",_e,"-"))]),"createdAt-cell":r(({row:a})=>[o("span",ye,i(s.$dayjs(a.original.createdAt).format("MM-DD HH:mm:ss")),1)]),"actions-cell":r(({row:a})=>[o("div",ve,[a.original.status==="failed"?(u(),C(t(h),{key:0,icon:"tabler:refresh",size:"xs",variant:"soft",color:"warning",onClick:J=>z(a.original.id)},{default:r(()=>[y(i(t(e)("dashboard.queue.buttons.retry")),1)]),_:1},8,["onClick"])):_("",!0),a.original.status!=="in-stage"?(u(),C(t(h),{key:1,icon:"tabler:trash",size:"xs",variant:"soft",color:"error",onClick:J=>w(a.original.id)},{default:r(()=>[y(i(t(e)("dashboard.queue.buttons.delete")),1)]),_:1},8,["onClick"])):_("",!0),a.original.status==="pending"||a.original.status==="in-stages"?(u(),f("span",xe," - ")):_("",!0)])]),expanded:r(({row:a})=>[o("div",qe,[o("div",ke,[o("div",$e,[o("div",null,[l[4]||(l[4]=o("p",{class:"text-xs text-neutral-500"},"PhotoId",-1)),o("p",Ce,i(a.original.payload.photoId||"-"),1)]),o("div",null,[o("p",Se,i(t(e)("dashboard.queue.table.id")),1),o("p",Te,i(a.original.id),1)]),o("div",null,[o("p",Ae,i(t(e)("dashboard.queue.table.type")),1),o("p",Ee,i(a.original.payload.type),1)])]),a.original.status==="failed"&&a.original.errorMessage?(u(),f("div",Ue,[o("p",De,i(t(e)("dashboard.queue.table.errorMessage")),1),o("div",Fe,[o("p",Ie,i(a.original.errorMessage),1)])])):_("",!0),a.original.payload?(u(),f("div",Ve,[l[5]||(l[5]=o("p",{class:"text-xs text-gray-500 mb-1"},"Payload",-1)),o("pre",ze,i(JSON.stringify(a.original.payload,null,2)),1)])):_("",!0)])])]),_:1},8,["expanded","data","loading","empty-state"])])]),_:1})])]),_:1})}}}),ta=oe(Be,[["__scopeId","data-v-e7a86c9e"]]);export{ta as default};
