import{C as G,bf as re,j as B,M as w,o as y,w as c,a as _,N as de,c as q,F as z,a5 as ce,O as l,R as K,H as I,a9 as pe,u as ue,aj as me,aA as R,K as H,aC as W,b as s,ah as x,d as Y,E as j,bj as fe}from"./Do4Ulm4h.js";import{_ as be,a as ge}from"./BxJwlH6u.js";import{_ as ve}from"./D2mnJjkG.js";import{a as J,_ as he}from"./CPK4N6jr.js";import{_ as ye}from"./Axqrd8Wi.js";import{a as _e,_ as $e}from"./BRFgOYk5.js";import{_ as ke}from"./Dt03dVmC.js";import{_ as Q}from"./D_BgBUvd.js";import{_ as Se}from"./Ds_hjWQ0.js";import{_ as Ue}from"./Ccp_Usjl.js";import{_ as xe}from"./BV9sba6H.js";import{_ as we}from"./DOw8EvtE.js";import{o as D,n as Ce,b as Ee,s as d,l as M,d as Ve}from"./oIv4vp1I.js";import"./D4m22CMA.js";import"./Bzg-qYo_.js";import"./Du2f8F9w.js";import"./zoi52lI1.js";import"./y8VeKFcA.js";import"./D8I6Rcxg.js";import"./C8barOil.js";import"./MPJDxmQh.js";import"./Qxlw5ViT.js";import"./DBhqu3Ka.js";import"./DN8WM3HB.js";import"./lxpLfLs2.js";import"./CTn4-S8R.js";import"./DdhnkgWh.js";import"./Duon1tOp.js";import"./KzhxPVJs.js";const Fe={class:"space-y-4"},Pe=G({__name:"AutoForm",props:{id:{default:void 0},schema:{default:void 0},state:{default:void 0},validate:{type:Function,default:void 0},validateOn:{default:void 0},disabled:{type:Boolean,default:void 0},validateOnInputDelay:{default:void 0},transform:{type:Boolean,default:!0},nested:{type:Boolean,default:void 0},loadingAuto:{type:Boolean,default:!0},class:{default:void 0},fieldsConfig:{default:void 0}},emits:["submit","error"],setup(i,{expose:g,emit:C}){const t=i,v=C,p=re("form"),O=B(()=>{if(!t.schema||!t.schema._def)return[];let o={};if(t.schema._def.discriminatedUnion){const b=t.schema._def.discriminator,u=t.state?.[b],$=t.schema._def.optionsMap?.get(u);$&&(o=$._def.shape?.()||{})}else if(typeof t.schema._def.shape=="function")o=t.schema._def.shape();else if(t.schema._def.shape)o=t.schema._def.shape;else return[];return Object.entries(o).map(([b,u])=>{const $=u._def?.type,E=u._def?.typeName,r=$==="optional"||E==="ZodOptional",k=r?u._def.innerType._def:u._def;let a="text",m="text";switch(k.type||k.typeName){case"boolean":case"ZodBoolean":{a="checkbox";break}case"number":case"ZodNumber":{a="number",m="number";break}case"enum":case"ZodEnum":{a="select";break}case"string":case"ZodString":{const U=k.checks||[],F=U.find(P=>P.kind==="email"),N=U.find(P=>P.kind==="url");F?m="email":N&&(m="url");break}}const A=b.replace(/([A-Z])/g," $1").replace(/^./,U=>U.toUpperCase()).trim(),n=t.fieldsConfig?.[b]||{},e=n.label??A,S=n.description;return{key:b,name:b,fieldType:a,inputType:m,isOptional:r,label:e,description:S,config:n}})}),V=o=>{v("submit",o)},T=o=>{v("error",o)};return g({submit:()=>p.value?.submit(),validate:o=>p.value?.validate(o),clear:o=>p.value?.clear(o),getErrors:o=>p.value?.getErrors(o),setErrors:(o,b)=>p.value?.setErrors(o,b),get errors(){return p.value?.errors},get disabled(){return p.value?.disabled},get dirty(){return p.value?.dirty},get dirtyFields(){return p.value?.dirtyFields},get touchedFields(){return p.value?.touchedFields},get blurredFields(){return p.value?.blurredFields}}),(o,b)=>{const u=Q,$=Ue,E=xe,r=J,k=he;return y(),w(k,{id:i.id,ref_key:"form",ref:p,schema:i.schema,state:i.state,validate:i.validate,"validate-on":i.validateOn,disabled:i.disabled,"validate-on-input-delay":i.validateOnInputDelay,transform:i.transform,nested:i.nested,"loading-auto":i.loadingAuto,onSubmit:V,onError:T},{default:c(()=>[_("div",Fe,[(y(!0),q(z,null,ce(l(O),a=>(y(),q(z,{key:a.key},[a.fieldType!=="hidden"&&!a.config?.hidden?(y(),w(r,{key:0,label:a.label,name:a.name,required:!a.isOptional,description:a.description,ui:{container:"sm:max-w-full"}},{default:c(()=>[a.fieldType==="text"?(y(),w(u,I({key:0,modelValue:i.state[a.key],"onUpdate:modelValue":m=>i.state[a.key]=m,type:a.inputType,placeholder:a.config?.placeholder??`${a.label.toLowerCase()}`,disabled:a.config?.disabled??!1,class:"w-full"},{ref_for:!0},a.config?.inputProps??{}),null,16,["modelValue","onUpdate:modelValue","type","placeholder","disabled"])):K("",!0),a.fieldType==="number"?(y(),w(u,I({key:1,modelValue:i.state[a.key],"onUpdate:modelValue":m=>i.state[a.key]=m,modelModifiers:{number:!0},type:"number",placeholder:a.config?.placeholder??`${a.label.toLowerCase()}`,disabled:a.config?.disabled??!1,class:"w-full"},{ref_for:!0},a.config?.inputProps??{}),null,16,["modelValue","onUpdate:modelValue","placeholder","disabled"])):K("",!0),a.fieldType==="checkbox"?(y(),w($,I({key:2,modelValue:i.state[a.key],"onUpdate:modelValue":m=>i.state[a.key]=m,label:a.label,disabled:a.config?.disabled??!1},{ref_for:!0},a.config?.checkboxProps??{}),null,16,["modelValue","onUpdate:modelValue","label","disabled"])):K("",!0),a.fieldType==="select"?(y(),w(E,I({key:3,modelValue:i.state[a.key],"onUpdate:modelValue":m=>i.state[a.key]=m,items:[],disabled:a.config?.disabled??!1,class:"w-full"},{ref_for:!0},a.config?.selectProps??{}),null,16,["modelValue","onUpdate:modelValue","disabled"])):K("",!0)]),_:2},1032,["label","name","required","description"])):K("",!0)],64))),128))]),de(o.$slots,"default")]),_:3},8,["id","schema","state","validate","validate-on","disabled","validate-on-input-delay","transform","nested","loading-auto"])}}}),Ke=Object.assign(Pe,{__name:"AutoForm"}),X=D({provider:M("s3"),bucket:d(),region:d().default("auto"),endpoint:d(),prefix:d().default("/photos").optional(),cdnUrl:d().optional(),accessKeyId:d(),secretAccessKey:d(),forcePathStyle:Ee().optional(),maxKeys:Ce().optional()}),ee=D({provider:M("local"),basePath:d().min(1),baseUrl:d().optional(),prefix:d().optional()}),te=D({provider:M("openlist"),baseUrl:d().min(1),rootPath:d().min(1),token:d().min(1),uploadEndpoint:d().default("/api/fs/put").optional(),downloadEndpoint:d().optional(),listEndpoint:d().optional(),deleteEndpoint:d().default("/api/fs/remove").optional(),metaEndpoint:d().default("/api/fs/get").optional(),pathField:d().default("path").optional(),cdnUrl:d().optional()});Ve("provider",[X,ee,te]);const Te={class:"space-y-6 max-w-6xl"},Ie={class:"space-y-4"},Oe={class:"flex items-center gap-3"},Ae={class:"w-full flex items-center justify-between"},Ne={class:"space-y-4"},mt=G({__name:"storage",async setup(i){let g,C;const{t}=pe();ue({title:t("title.storageSettings")});const v=me(),{data:p,refresh:O}=([g,C]=R(()=>W("/api/system/settings/storage/provider","$ynzDBib5OO")),g=await g,C(),g),{data:V,refresh:T}=([g,C]=R(()=>W("/api/system/settings/storage-config","$YpEhMMMjI5")),g=await g,C(),g),o={s3:"tabler:brand-aws",local:"tabler:database",openlist:"tabler:cloud"},b=[{accessorKey:"status",header:"",meta:{class:{th:"w-10"}},cell:n=>{const e=p.value?.value===n.row.original.id;return j(fe,{size:"md",inset:!0,standalone:!0,color:e?"success":void 0,ui:{base:e?"":"bg-neutral-200 dark:bg-neutral-700"}})}},{accessorKey:"name",header:"存储名称"},{accessorKey:"provider",header:"存储类型"},{accessorKey:"actions",header:"操作",cell:n=>j("div",{class:"flex items-center gap-2"},[j(x,{size:"sm",variant:"soft",color:"error",icon:"tabler:trash",disabled:p.value?.value===n.row.original.id,onClick:()=>A(n.row.original.id)},{default:()=>"删除"})])}],u=H({storageConfigId:p.value?p.value.value:void 0}),$=async n=>{try{await $fetch("/api/system/settings/storage/provider",{method:"PUT",body:{value:u.storageConfigId}}),O(),n?.(),v.add({title:"设置已保存",color:"success"})}catch(e){v.add({title:"保存设置时出错",description:e.message,color:"error"})}},E=[{label:"AWS S3 兼容存储",value:"s3",icon:o.s3},{label:"本地存储",value:"local",icon:o.local},{label:"OpenList",value:"openlist",icon:o.openlist}],r=H({name:"",provider:"s3",config:{provider:"s3",region:"auto",prefix:"/photos"}}),k=B(()=>{switch(r.provider){case"local":return ee;case"openlist":return te;default:return X}}),a=n=>{switch(n){case"local":return{provider:"local",basePath:"/data/storage",baseUrl:"/storage"};case"openlist":return{provider:"openlist",uploadEndpoint:"/api/fs/put",deleteEndpoint:"/api/fs/remove",metaEndpoint:"/api/fs/get",pathField:"path"};default:return{provider:"s3",region:"auto",prefix:"/photos"}}},m=B(()=>{const n=r.provider,e=`settings.storage.${n}`;switch(n){case"local":return{provider:{hidden:!0},basePath:{label:t(`${e}.basePath.label`),description:t(`${e}.basePath.description`)},baseUrl:{label:t(`${e}.baseUrl.label`),description:t(`${e}.baseUrl.description`)},prefix:{label:t(`${e}.prefix.label`),description:t(`${e}.prefix.description`)}};case"openlist":return{provider:{hidden:!0},baseUrl:{label:t(`${e}.baseUrl.label`),description:t(`${e}.baseUrl.description`)},rootPath:{label:t(`${e}.rootPath.label`),description:t(`${e}.rootPath.description`)},token:{label:t(`${e}.token.label`),description:t(`${e}.token.description`)},uploadEndpoint:{label:t(`${e}.uploadEndpoint.label`),description:t(`${e}.uploadEndpoint.description`)},downloadEndpoint:{label:t(`${e}.downloadEndpoint.label`),description:t(`${e}.downloadEndpoint.description`)},listEndpoint:{label:t(`${e}.listEndpoint.label`),description:t(`${e}.listEndpoint.description`)},deleteEndpoint:{label:t(`${e}.deleteEndpoint.label`),description:t(`${e}.deleteEndpoint.description`)},metaEndpoint:{label:t(`${e}.metaEndpoint.label`),description:t(`${e}.metaEndpoint.description`)},pathField:{label:t(`${e}.pathField.label`),description:t(`${e}.pathField.description`)},cdnUrl:{label:t(`${e}.cdnUrl.label`),description:t(`${e}.cdnUrl.description`)}};default:return{provider:{hidden:!0},bucket:{label:t(`${e}.bucket.label`),description:t(`${e}.bucket.description`)},region:{label:t(`${e}.region.label`),description:t(`${e}.region.description`)},endpoint:{label:t(`${e}.endpoint.label`),description:t(`${e}.endpoint.description`)},prefix:{label:t(`${e}.prefix.label`),description:t(`${e}.prefix.description`)},cdnUrl:{label:t(`${e}.cdnUrl.label`),description:t(`${e}.cdnUrl.description`)},accessKeyId:{label:t(`${e}.accessKeyId.label`),description:t(`${e}.accessKeyId.description`)},secretAccessKey:{label:t(`${e}.secretAccessKey.label`),description:t(`${e}.secretAccessKey.description`)},forcePathStyle:{label:t(`${e}.forcePathStyle.label`),description:t(`${e}.forcePathStyle.description`)},maxKeys:{label:t(`${e}.maxKeys.label`),description:t(`${e}.maxKeys.description`)}}}}),L=async(n,e)=>{try{const S={name:r.name,provider:r.provider,config:n.data};await $fetch("/api/system/settings/storage-config",{method:"POST",body:S}),T(),v.add({title:"存储方案已创建",color:"success"}),r.name="",r.provider="s3",r.config=a("s3"),e?.()}catch(S){v.add({title:"创建存储方案时出错",description:S.message,color:"error"})}},A=async n=>{try{await $fetch(`/api/system/settings/storage-config/${n}`,{method:"DELETE"}),T(),v.add({title:"存储方案已删除",color:"success"})}catch(e){v.add({title:"删除存储方案失败",description:e.message,color:"error"})}};return(n,e)=>{const S=ge,U=ve,F=J,N=ye,P=_e,Z=ke,ae=Q,oe=Se,le=Ke,ne=$e,se=we,ie=be;return y(),w(ie,null,{header:c(()=>[s(S,{title:l(t)("title.storageSettings")},null,8,["title"])]),body:c(()=>[_("div",Te,[s(Z,{variant:"outline"},{footer:c(()=>[_("div",Oe,[s(P,{title:"变更存储方案",ui:{footer:"justify-end"}},{body:c(()=>[s(N,{color:"neutral",variant:"subtle",title:"注意",description:"变更存储方案之后上传的文件将会存储到新的存储方案中，原方案中已有文件不会被迁移。",icon:"tabler:arrows-exchange"})]),footer:c(({close:f})=>[s(l(x),{label:"取消",color:"neutral",variant:"outline",onClick:f},null,8,["onClick"]),s(l(x),{label:"登录",variant:"soft",icon:"tabler:arrows-exchange",type:"submit",form:"storageSettingsForm",onClick:h=>$(f)},null,8,["onClick"])]),default:c(()=>[s(l(x),{variant:"soft",icon:"tabler:device-floppy"},{default:c(()=>[...e[4]||(e[4]=[Y(" 保存设置 ",-1)])]),_:1})]),_:1})])]),default:c(()=>[_("div",Ie,[s(F,{name:"storageConfigId",label:"存储方案",required:"",ui:{container:"w-full sm:max-w-sm *:w-full"}},{default:c(()=>[s(U,{modelValue:l(u).storageConfigId,"onUpdate:modelValue":e[0]||(e[0]=f=>l(u).storageConfigId=f),icon:o[l(V)?.find(f=>f.id===l(u).storageConfigId)?.provider||"local"]||"tabler:database",items:l(V)?.map(f=>({icon:o[f.provider]||"tabler:database",label:f.name,value:f.id})),"label-key":"label","value-key":"value",placeholder:"选择存储方案"},null,8,["modelValue","icon","items"])]),_:1})])]),_:1}),s(Z,{variant:"outline",ui:{body:"p-0 sm:p-0"}},{header:c(()=>[_("div",Ae,[e[6]||(e[6]=_("span",null,"存储方案管理",-1)),_("div",null,[s(ne,{title:"创建存储方案",ui:{footer:"justify-end"}},{body:c(({close:f})=>[_("div",Ne,[s(F,{label:"存储类型",class:"w-full",required:"",ui:{container:"sm:max-w-full"}},{default:c(()=>[s(U,{modelValue:l(r).provider,"onUpdate:modelValue":[e[1]||(e[1]=h=>l(r).provider=h),e[2]||(e[2]=h=>{l(r).provider=h,l(r).config=a(h)})],icon:o[l(r).provider]||"tabler:database",items:E,"label-key":"label","value-key":"value",placeholder:"选择存储类型"},null,8,["modelValue","icon"])]),_:1}),s(F,{label:"存储名称",required:"",ui:{container:"sm:max-w-full"}},{default:c(()=>[s(ae,{modelValue:l(r).name,"onUpdate:modelValue":e[3]||(e[3]=h=>l(r).name=h)},null,8,["modelValue"])]),_:1}),s(oe),s(le,{id:"createStorageForm",schema:l(k),state:l(r).config,"fields-config":l(m),onSubmit:h=>L(h,f)},null,8,["schema","state","fields-config","onSubmit"])])]),footer:c(({close:f})=>[s(l(x),{label:"取消",color:"neutral",variant:"outline",onClick:f},null,8,["onClick"]),s(l(x),{label:"创建存储",variant:"soft",icon:"tabler:check",type:"submit",form:"createStorageForm"})]),default:c(()=>[s(l(x),{size:"sm",variant:"soft",icon:"tabler:plus"},{default:c(()=>[...e[5]||(e[5]=[Y(" 添加存储 ",-1)])]),_:1})]),_:1})])])]),default:c(()=>[_("div",null,[s(se,{columns:b,data:l(V)},null,8,["data"])])]),_:1})])]),_:1})}}});export{mt as default};
